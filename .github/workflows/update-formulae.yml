name: Update MCP Formulas

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

permissions:
  contents: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - project: MCP-ZedChat
            formula: mcp-zedchat.rb
            tarball: mcp-zedchat-macos.tar.gz
          - project: MCP-WebReader
            formula: mcp-webreader.rb
            tarball: mcp-webreader-macos.tar.gz
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get latest release info for ${{ matrix.project }}
        id: release
        run: |
          # Fetch latest release from GitHub API
          RELEASE_JSON=$(curl -sL "https://api.github.com/repos/mredig/${{ matrix.project }}/releases/latest")
          VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          
          echo "Latest version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check current version in formula
          CURRENT_VERSION=$(grep -oP 'releases/download/\K[^/]+' ${{ matrix.formula }})
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Download SHA256 from release
          curl -sL "https://github.com/mredig/${{ matrix.project }}/releases/download/${VERSION}/${{ matrix.tarball }}.sha256" -o sha256.txt
          SHA256=$(cat sha256.txt | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          echo "Downloaded SHA256: $SHA256"
      
      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.release.outputs.version }}" = "${{ steps.release.outputs.current_version }}" ]; then
            echo "Formula is already up to date"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "Update needed: ${{ steps.release.outputs.current_version }} -> ${{ steps.release.outputs.version }}"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Update formula
        if: steps.check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          SHA256="${{ steps.release.outputs.sha256 }}"
          
          # Update version and SHA in formula
          sed -i.bak "s|releases/download/[^/]*/${{ matrix.tarball }}|releases/download/${VERSION}/${{ matrix.tarball }}|" ${{ matrix.formula }}
          sed -i.bak "s|sha256 \".*\"|sha256 \"${SHA256}\"|" ${{ matrix.formula }}
          rm ${{ matrix.formula }}.bak
          
          cat ${{ matrix.formula }}
      
      - name: Commit and push
        if: steps.check.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ matrix.formula }}
          git commit -m "chore: update ${{ matrix.formula }} to ${{ steps.release.outputs.version }}"
          git push